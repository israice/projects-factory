<!DOCTYPE html>
<html>
<head>
    <title>GitHub Repositories</title>
    <style>
        body{font-family:Arial,sans-serif;padding:20px}
        .navbar{background:#333;padding:10px 20px 0;margin:-20px -20px 0;display:flex;gap:10px}
        .navbar a{color:#fff;text-decoration:none;padding:8px 16px;border-radius:4px;cursor:default}
        .header{background:#333;padding:0 20px 10px;margin:0 -20px 20px;display:flex;justify-content:space-between;align-items:center;gap:20px}
        .header a{color:#fff;text-decoration:none;padding:8px 16px;border-radius:4px}
        .header a:hover{background:#555}
        .welcome-text{color:#0f0;font-weight:700;font-family:'Courier New',monospace;font-size:16px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#4CAF50;color:#fff}
        tr:nth-child(even){background:#f2f2f2}
        .profile-repo{background:#fff3cd!important;font-weight:700}
        .profile-repo td{border:2px solid #ffc107}
        .installed-row{background:#d4edda!important}
        .installed-row td{border-color:#28a745}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal{background:#fff;padding:25px;border-radius:8px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,.3)}
        .modal h3{margin:0 0 15px;color:#333}
        .modal-body{background:#f5f5f5;padding:15px;border-radius:4px;margin:15px 0;max-height:200px;overflow-y:auto;font:13px monospace}
        .modal-buttons{display:flex;gap:10px;justify-content:flex-end}
        .modal-btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px}
        .modal-btn-cancel{background:#6c757d;color:#fff}
        .modal-btn-cancel:hover{background:#5a6268}
        .modal-btn-confirm{background:#28a745;color:#fff}
        .modal-btn-confirm:hover{background:#218838}
        th.sortable{cursor:pointer;user-select:none}
        th.sortable:hover{background:#5CAF50}
        th.sort-asc::after{content:" ‚ñ≤";font-size:12px}
        th.sort-desc::after{content:" ‚ñº";font-size:12px}
    </style>
</head>
<body>
    <div id="panel-1" class="navbar">
        <a href="#">üë® User: {{ username }}</a>
        <a href="#">üì¶ Repos: {{ count }}</a>
        <a href="#" id="installed-count">üìÅ Installed: {{ installed_count }}</a>
    </div>
    <div id="panel-2" class="header">
        <span class="welcome-text" id="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä</span>
        <div class="header-buttons">
            <a href="/refresh">üîÑ Refresh</a>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <h3>Confirm Installation</h3>
            <div class="modal-body" id="modal-repo-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">Install</button>
            </div>
        </div>
    </div>
    <table>
        <tr><th></th><th class="sortable" data-sort="name">Name</th><th class="sortable" data-sort="url">URL</th><th class="sortable" data-sort="private">Private</th><th class="sortable" data-sort="description">Description</th><th class="sortable" data-sort="created_at">Created</th></tr>
        {% for repo in repos %}
        {% set normalized_url = repo.url[:-4] if repo.url.endswith('.git') else repo.url %}
        {% set normalized_url = normalized_url.rstrip('/') %}
        <tr{% if repo.name == username %} class="profile-repo"{% elif normalized_url in installed_repos %} class="installed-row"{% endif %}>
            <td class="settings-cell" data-repo="{{ repo.name }}" data-url="{{ repo.url }}" title="Settings for {{ repo.name }}"><button type="button" class="settings-btn">‚öôÔ∏è</button></td>
            <td>{{ repo.name }}</td>
            <td><a href="{{ repo.url }}" target="_blank">{{ repo.url }}</a></td>
            <td>{{ "‚úì" if repo.private else "" }}</td>
            <td>{{ repo.description or "" }}</td>
            <td>{{ repo.created_at[:10] if repo.created_at and repo.created_at else "" }}</td>
        </tr>
        {% endfor %}
    </table>
    <style>
        .action-row{display:none;background:#f9f9f9}
        .action-row.show{display:table-row}
        .action-cell{padding:5px;text-align:center}
        .action-btn{display:inline-flex;flex-direction:row;align-items:center;gap:5px;padding:6px 12px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;margin:0 5px}
        .action-btn:hover{background:#e9e9e9;border-color:#bbb}
        .action-btn-icon{font-size:16px}
        .action-btn-label{font-size:11px;color:#555}
        .settings-cell{cursor:pointer;padding:5px;text-align:center}
        .settings-cell:hover{background:#e9e9e9}
        .settings-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:5px;opacity:0.8;color:#333;pointer-events:none}
        .settings-btn:hover{opacity:1;color:#000}
        .settings-btn.active{opacity:1;color:#000;transform:rotate(30deg)}
    </style>
    <script>
        document.addEventListener("DOMContentLoaded",function(){
            const settingsCells=document.querySelectorAll(".settings-cell"),installedCountEl=document.getElementById("installed-count"),modal=document.getElementById("confirm-modal"),modalRepoList=document.getElementById("modal-repo-list"),modalCancel=document.getElementById("modal-cancel"),modalConfirm=document.getElementById("modal-confirm"),welcomeText=document.getElementById("welcome-text");
            let sortColumn=null,sortDirection=1,pendingInstall=null;
            
            // Toggle action row on settings cell click
            settingsCells.forEach(cell=>{
                cell.addEventListener("click",function(e){
                    e.stopPropagation();
                    
                    const row=this.closest("tr");
                    const repoName=this.dataset.repo;
                    const repoUrl=this.dataset.url;
                    const settingsBtn=this.querySelector(".settings-btn");
                    const isActive=settingsBtn.classList.contains("active");
                    
                    // Reset all cells
                    settingsCells.forEach(otherCell=>{
                        const otherBtn=otherCell.querySelector(".settings-btn");
                        otherBtn.classList.remove("active");
                        const otherActionRow=otherCell.closest("tr").nextElementSibling;
                        if(otherActionRow&&otherActionRow.classList.contains("action-row")){
                            otherActionRow.classList.remove("show");
                        }
                    });
                    
                    // Toggle current
                    if(!isActive){
                        settingsBtn.classList.add("active");
                        let actionRow=row.nextElementSibling;
                        if(!actionRow||!actionRow.classList.contains("action-row")){
                            actionRow=document.createElement("tr");
                            actionRow.className="action-row";
                            actionRow.id="bottom-panel-"+repoName;
                            actionRow.innerHTML='<td colspan="6" class="action-cell"><button class="action-btn" data-action="install" data-name="'+repoName+'" data-url="'+repoUrl+'"><span class="action-btn-icon">üì•</span><span class="action-btn-label">Install</span></button></td>';
                            row.parentNode.insertBefore(actionRow,row.nextSibling);
                        }
                        actionRow.classList.add("show");
                    }
                });
            });
            
            // Handle action button clicks
            document.addEventListener("click",function(e){
                const actionBtn=e.target.closest(".action-btn");
                if(!actionBtn)return;
                e.stopPropagation();
                e.preventDefault();
                const action=actionBtn.dataset.action;
                const repoName=actionBtn.dataset.name;
                const repoUrl=actionBtn.dataset.url;
                if(action==="install"){
                    pendingInstall={name:repoName,url:repoUrl};
                    modalRepoList.textContent=repoName;
                    modal.style.display="flex";
                }else if(action==="open"){
                    // TODO: Add open logic here
                }else if(action==="settings"){
                    // TODO: Add settings logic here
                }else if(action==="delete"){
                    // TODO: Add delete logic here
                }
            });
            
            modalCancel.addEventListener("click",function(){modal.style.display="none";pendingInstall=null});
            modalConfirm.addEventListener("click",async function(){
                if(!pendingInstall)return;
                modal.style.display="none";
                welcomeText.textContent="‚è≥ Installing "+pendingInstall.name+"...";
                try{
                    const response=await fetch("/install",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({repos:[pendingInstall.url]})});
                    const data=await response.json();
                    if(data.success){
                        if(data.installed_count!==undefined&&installedCountEl)installedCountEl.textContent="üìÅ Installed: "+data.installed_count;
                        welcomeText.textContent="‚úÖ Installed "+pendingInstall.name;
                        const settingsCell=document.querySelector(`.settings-cell[data-url="${pendingInstall.url}"]`);
                        if(settingsCell){
                            const settingsBtn=settingsCell.querySelector(".settings-btn");
                            settingsBtn.classList.remove("active");
                            settingsCell.closest("tr").classList.add("installed-row");
                            const actionRow=settingsCell.closest("tr").nextElementSibling;
                            if(actionRow&&actionRow.classList.contains("action-row"))actionRow.classList.remove("show");
                        }
                    }else{
                        welcomeText.textContent="‚ùå Installation failed";
                    }
                }catch(err){
                    welcomeText.textContent="‚ùå Request failed: "+err.message;
                }
                pendingInstall=null;
            });
            modal.addEventListener("click",function(e){if(e.target===modal){modal.style.display="none";pendingInstall=null}});
            
            welcomeText.addEventListener("click",function(){welcomeText.textContent="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä";welcomeText.className="welcome-text"});
            // Sorting functionality
            document.querySelectorAll("th.sortable").forEach(th=>{
                th.addEventListener("click",function(){
                    const column=this.dataset.sort;
                    const table=this.closest("table");
                    const rows=Array.from(table.querySelectorAll("tr"));
                    if(sortColumn===column){sortDirection=-sortDirection}else{sortColumn=column;sortDirection=1}
                    document.querySelectorAll("th.sortable").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
                    this.classList.add(sortDirection===1?"sort-asc":"sort-desc");
                    rows.sort((a,b)=>{
                        let aVal,bVal;
                        if(column==="name"){aVal=a.cells[0].textContent.trim();bVal=b.cells[0].textContent.trim();}
                        else if(column==="url"){aVal=a.cells[1].textContent.trim();bVal=b.cells[1].textContent.trim();}
                        else if(column==="private"){aVal=a.cells[2].textContent.trim()?"1":"";bVal=b.cells[2].textContent.trim()?"1":"";}
                        else if(column==="description"){aVal=a.cells[3].textContent.trim();bVal=b.cells[3].textContent.trim();}
                        else if(column==="created_at"){aVal=a.cells[4].textContent.trim();bVal=b.cells[4].textContent.trim();}
                        else{return 0;}
                        if(aVal<bVal)return -1*sortDirection;if(aVal>bVal)return 1*sortDirection;return 0;
                    });
                    rows.forEach(row=>table.appendChild(row))
                })
            });
        });
    </script>
</body>
</html>
