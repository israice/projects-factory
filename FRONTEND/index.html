<!DOCTYPE html>
<html>
<head>
    <title>GitHub Repositories</title>
    <style>
        body{font-family:Arial,sans-serif;padding:20px;background:#1e1e1e;color:#e0e0e0}
        .logo-wrapper{background:#2d2d2d;display:flex;align-items:center;justify-content:center;min-width:80px;padding-right:0}
        .logo-container{display:flex;align-items:center;justify-content:center;width:100%;padding:10px 0 10px 20px}
        .logo-img{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #4CAF50}
        .logo-icon{font-size:48px;font-weight:700;color:#4CAF50;text-decoration:none;display:flex;align-items:center;justify-content:center}
        .navbar{background:#2d2d2d;padding:10px 20px 0;margin:0;display:flex;gap:10px;align-items:center}
        .navbar a{color:#e0e0e0;text-decoration:none;padding:8px 16px;border-radius:4px;cursor:default;margin-left:0}
        .navbar a:first-child{margin-left:0;padding-left:0}
        .navbar a[href="/refresh"],.navbar a[href="/create-new"]{cursor:pointer}
        .navbar a[href="/refresh"]:hover,.navbar a[href="/create-new"]:hover{background:#404040}
        .header{background:#2d2d2d;padding:0 20px 10px;margin:0;display:flex;justify-content:center;align-items:center;gap:20px}
        .header a{color:#e0e0e0;text-decoration:none;padding:8px 16px;border-radius:4px}
        .header a:hover{background:#404040}
        .welcome-text{color:#0f0;font-weight:700;font-family:'Courier New',monospace;font-size:16px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #444;padding:8px;text-align:left}
        th{background:#2e7d32;color:#fff;text-align:center}
        tr{background:#1e1e1e}
        .installed-row{background:#1b3320!important}
        .installed-row td{border-color:#2e7d32}
        .new-project-row{background:#3d3d1b!important}
        .new-project-row td{border-color:#9e9d24}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal{background:#2d2d2d;padding:25px;border-radius:8px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,.3);color:#e0e0e0}
        .modal h3{margin:0 0 15px;color:#e0e0e0}
        .modal-body{background:#1e1e1e;padding:15px;border-radius:4px;margin:15px 0;max-height:200px;overflow-y:auto;font:13px monospace;color:#e0e0e0}
        .modal-buttons{display:flex;gap:10px;justify-content:flex-end}
        .modal-btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px}
        .modal-btn-cancel{background:#4a4a4a;color:#e0e0e0}
        .modal-btn-cancel:hover{background:#5a5a5a}
        .modal-btn-confirm{background:#2e7d32;color:#fff}
        .modal-btn-confirm:hover{background:#388e3c}
        th.sortable{cursor:pointer;user-select:none}
        th.sortable:hover{background:#5CAF50}
        .date-badge{display:inline-flex;align-items:center;background:linear-gradient(135deg,#2e7d32,#1b5e20);color:#fff;font-size:11px;font-weight:600;padding:4px 10px;border-radius:12px;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,.3);transition:transform .2s}
        .date-badge:hover{transform:scale(1.05)}
        td:nth-child(3){text-align:left}
        td:nth-child(4){text-align:center;vertical-align:middle}
    </style>
</head>
<body>
    <div style="display:flex;align-items:stretch;gap:0">
        <div class="logo-wrapper">
            <div class="logo-container">
                {% if avatar_url %}
                <img src="{{ avatar_url }}" alt="Logo" class="logo-img">
                {% else %}
                <span class="logo-icon">üì¶</span>
                {% endif %}
            </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column">
            <div id="panel-1" class="navbar">
                <a href="#">üë® User: {{ username }}</a>
                <a href="#">üì¶ Repos: {{ count }}</a>
                <a href="#" id="installed-count">üìÅ Installed: {{ installed_count }}</a>
                <a href="/create-new" style="margin-left:auto">‚ûï Create New</a>
                <a href="/refresh">üîÑ Refresh</a>
            </div>
            <div id="panel-2" class="header">
                <span class="welcome-text" id="welcome-text">{% if message %}{{ message }}{% else %}–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä{% endif %}</span>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <h3>Confirm Installation</h3>
            <div class="modal-body" id="modal-repo-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">Install</button>
            </div>
        </div>
    </div>
    <div id="delete-modal" class="modal-overlay">
        <div class="modal">
            <h3>Confirm Deletion</h3>
            <div class="modal-body" id="modal-delete-repo-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-delete-cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modal-delete-confirm" style="background:#dc3545">Delete</button>
            </div>
        </div>
    </div>
    <table>
        <tr><th>Logo</th><th class="sortable" data-sort="name">Projets</th><th class="sortable" data-sort="description">Description</th><th class="sortable" data-sort="url">URL</th><th class="sortable" data-sort="created_at">Started</th></tr>
        {% for repo in repos %}
        {% set normalized_url = repo.url[:-4] if repo.url.endswith('.git') else repo.url %}
        {% set normalized_url = normalized_url.rstrip('/') %}
        {% set is_installed = normalized_url in installed_repos %}
        {% set is_new_project = repo.get('is_new_project', False) %}
        <tr{% if is_new_project %} class="new-project-row"{% elif is_installed %} class="installed-row"{% endif %}>
            <td class="logo-cell">{% if avatar_url %}<img src="{{ avatar_url }}" alt="Logo" class="repo-logo">{% else %}<span class="logo-icon" style="font-size:32px">üì¶</span>{% endif %}</td>
            <td class="name-cell" data-repo="{{ repo.name }}" data-url="{{ repo.url }}" title="Click to install/delete">{{ repo.name }}</td>
            <td>{{ repo.description or "" }}</td>
            <td class="private-cell" data-url="{{ repo.url }}">{% if is_new_project %}üìÅ{% else %}{{ "üîí" if repo.private else "üåç" }}{% endif %}</td>
            <td><span class="date-badge">{{ repo.created_at[:10] if repo.created_at and repo.created_at else "" }}</span></td>
        </tr>
        {% endfor %}
    </table>
    <script src="/livereload.js"></script>
    <style>
        .action-row{display:none;background:#3d3d2a}
        .action-row.show{display:table-row!important;background:#3d3d2a!important}
        .action-cell{padding:5px;text-align:center}
        .action-btn{display:inline-flex;flex-direction:row;align-items:center;gap:5px;padding:6px 12px;border:1px solid #444;background:#2d2d2d;cursor:pointer;margin:0 5px;color:#e0e0e0}
        .action-btn:hover{background:#404040;border-color:#555}
        .action-btn-icon{font-size:16px}
        .action-btn-label{font-size:11px;color:#b0b0b0}
        .logo-cell{text-align:center;vertical-align:middle;width:60px}
        .repo-logo{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .name-cell{cursor:pointer}
        .name-cell:hover{background:#404040}
        .name-cell.active{background:#1b3320}
        .private-cell{cursor:pointer;color:#4CAF50;text-align:center;vertical-align:middle}
        .private-cell:hover{background:#404040}
    </style>
    <script>
        document.addEventListener("DOMContentLoaded",function(){
            const nameCells=document.querySelectorAll(".name-cell"),installedCountEl=document.getElementById("installed-count"),modal=document.getElementById("confirm-modal"),modalRepoList=document.getElementById("modal-repo-list"),modalCancel=document.getElementById("modal-cancel"),modalConfirm=document.getElementById("modal-confirm"),welcomeText=document.getElementById("welcome-text");
            const deleteModal=document.getElementById("delete-modal"),modalDeleteRepoList=document.getElementById("modal-delete-repo-list"),modalDeleteCancel=document.getElementById("modal-delete-cancel"),modalDeleteConfirm=document.getElementById("modal-delete-confirm");
            let sortColumn="created_at",sortDirection=-1,pendingInstall=null,pendingDelete=null;

            // Get table structure dynamically
            const table=document.querySelector("table");
            const headerRow=table.querySelector("tr:first-child");
            const totalColumns=headerRow.children.length;

            // Find created_at column index dynamically
            const createdAtTh=headerRow.querySelector('[data-sort="created_at"]');
            const createdAtIndex=createdAtTh?Array.from(headerRow.children).indexOf(createdAtTh):totalColumns-1;

            // Sort by created_at column by default (descending - newest first)
            const rows=Array.from(table.querySelectorAll("tr:not(:first-child)"));
            document.querySelectorAll("th.sortable").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
            if(createdAtTh){
                createdAtTh.classList.add("sort-desc");
                rows.sort((a,b)=>{
                    const aVal=a.cells[createdAtIndex].textContent.trim();
                    const bVal=b.cells[createdAtIndex].textContent.trim();
                    if(aVal<bVal)return 1;if(aVal>bVal)return -1;return 0;
                });
                rows.forEach(row=>table.appendChild(row));
            }
            table.insertBefore(headerRow,table.firstChild);

            // Toggle action row on name cell click
            nameCells.forEach(cell=>{
                cell.addEventListener("click",function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    openActionRow(this);
                });
            });

            // Open repo URL when clicking on private cell
            document.querySelectorAll(".private-cell").forEach(cell=>{
                cell.addEventListener("click",function(e){
                    e.stopPropagation();
                    const url=this.dataset.url;
                    if(url)window.open(url,"_blank");
                });
            });

            function openActionRow(cell){
                const row=cell.closest("tr");
                const repoName=cell.dataset.repo;
                const repoUrl=cell.dataset.url;
                const isActive=cell.classList.contains("active");

                // Reset all cells
                nameCells.forEach(otherCell=>{
                    otherCell.classList.remove("active");
                    const otherActionRow=otherCell.closest("tr").nextElementSibling;
                    if(otherActionRow&&otherActionRow.classList.contains("action-row")){
                        otherActionRow.classList.remove("show");
                    }
                });

                // Toggle current
                if(!isActive){
                    cell.classList.add("active");
                    let actionRow=row.nextElementSibling;
                    const isInstalled=row.classList.contains("installed-row");
                    const isNewProject=row.classList.contains("new-project-row");
                    if(!actionRow||!actionRow.classList.contains("action-row")){
                        actionRow=document.createElement("tr");
                        actionRow.className="action-row";
                        actionRow.id="bottom-panel-"+repoName;
                        // Show Delete for installed rows and new projects, Install for non-installed
                        if(isInstalled||isNewProject){
                            actionRow.innerHTML='<td colspan="'+totalColumns+'" class="action-cell"><button class="action-btn" data-action="delete" data-name="'+repoName+'" data-url="'+repoUrl+'"><span class="action-btn-icon">üóëÔ∏è</span><span class="action-btn-label">Delete</span></button></td>';
                        }else{
                            actionRow.innerHTML='<td colspan="'+totalColumns+'" class="action-cell"><button class="action-btn" data-action="install" data-name="'+repoName+'" data-url="'+repoUrl+'"><span class="action-btn-icon">üì•</span><span class="action-btn-label">Install</span></button></td>';
                        }
                        row.parentNode.insertBefore(actionRow,row.nextSibling);
                    }
                    actionRow.classList.add("show");
                }
            }

            // Handle action button clicks
            document.addEventListener("click",function(e){
                const actionBtn=e.target.closest(".action-btn");
                if(!actionBtn)return;
                e.stopPropagation();
                e.preventDefault();
                const action=actionBtn.dataset.action;
                const repoName=actionBtn.dataset.name;
                const repoUrl=actionBtn.dataset.url;
                if(action==="install"){
                    pendingInstall={name:repoName,url:repoUrl};
                    modalRepoList.textContent=repoName;
                    modal.style.display="flex";
                }else if(action==="delete"){
                    pendingDelete={name:repoName,url:repoUrl};
                    modalDeleteRepoList.textContent=repoName;
                    deleteModal.style.display="flex";
                }else if(action==="open"){
                    window.open(repoUrl,"_blank");
                }else if(action==="settings"){
                    window.open(repoUrl,"_blank");
                }
            });

            modalCancel.addEventListener("click",function(){modal.style.display="none";pendingInstall=null});
            modalConfirm.addEventListener("click",async function(){
                if(!pendingInstall)return;
                modal.style.display="none";
                welcomeText.textContent="‚è≥ Installing "+pendingInstall.name+"...";
                try{
                    const response=await fetch("/install",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({repos:[pendingInstall.url]})});
                    const data=await response.json();
                    if(data.success){
                        if(data.installed_count!==undefined&&installedCountEl)installedCountEl.textContent="üìÅ Installed: "+data.installed_count;
                        welcomeText.textContent="‚úÖ Installed "+pendingInstall.name;
                        const nameCell=document.querySelector(`.name-cell[data-url="${pendingInstall.url}"]`);
                        if(nameCell){
                            nameCell.classList.remove("active");
                            nameCell.closest("tr").classList.add("installed-row");
                            const actionRow=nameCell.closest("tr").nextElementSibling;
                            if(actionRow&&actionRow.classList.contains("action-row"))actionRow.classList.remove("show");
                        }
                    }else{
                        welcomeText.textContent="‚ùå Installation failed";
                    }
                }catch(err){
                    welcomeText.textContent="‚ùå Request failed: "+err.message;
                }
                pendingInstall=null;
            });
            modal.addEventListener("click",function(e){if(e.target===modal){modal.style.display="none";pendingInstall=null}});

            modalDeleteCancel.addEventListener("click",function(){deleteModal.style.display="none";pendingDelete=null});
            modalDeleteConfirm.addEventListener("click",async function(){
                if(!pendingDelete)return;
                deleteModal.style.display="none";
                welcomeText.textContent="‚è≥ Deleting "+pendingDelete.name+"...";
                try{
                    const response=await fetch("/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({repos:[pendingDelete.name]})});
                    const data=await response.json();
                    if(data.success){
                        if(data.installed_count!==undefined&&installedCountEl)installedCountEl.textContent="üìÅ Installed: "+data.installed_count;
                        welcomeText.textContent="‚úÖ Deleted "+pendingDelete.name;
                        const nameCell=document.querySelector(`.name-cell[data-url="${pendingDelete.url}"]`);
                        if(nameCell){
                            nameCell.classList.remove("active");
                            const row=nameCell.closest("tr");
                            row.classList.remove("installed-row","new-project-row");
                            // Remove the row for new projects, or just remove installed class for MY_REPOS
                            if(pendingDelete.url.includes("NEW_PROJECTS")){
                                row.style.display="none";
                            }
                            const actionRow=row.nextElementSibling;
                            if(actionRow&&actionRow.classList.contains("action-row"))actionRow.classList.remove("show");
                        }
                    }else{
                        welcomeText.textContent="‚ùå Deletion failed";
                    }
                }catch(err){
                    welcomeText.textContent="‚ùå Request failed: "+err.message;
                }
                pendingDelete=null;
            });
            deleteModal.addEventListener("click",function(e){if(e.target===deleteModal){deleteModal.style.display="none";pendingDelete=null}});
            
            welcomeText.addEventListener("click",function(){welcomeText.textContent="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä";welcomeText.className="welcome-text"});
            // Sorting functionality
            document.querySelectorAll("th.sortable").forEach(th=>{
                th.addEventListener("click",function(){
                    const column=this.dataset.sort;
                    const table=this.closest("table");
                    const headerRow=table.querySelector("tr:first-child");
                    // Exclude action rows from sorting
                    const rows=Array.from(table.querySelectorAll("tr:not(:first-child):not(.action-row)"));
                    if(sortColumn===column){sortDirection=-sortDirection}else{sortColumn=column;sortDirection=1}
                    document.querySelectorAll("th.sortable").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
                    this.classList.add(sortDirection===1?"sort-asc":"sort-desc");

                    // Get column index dynamically
                    const columnIndex=Array.from(headerRow.children).indexOf(this);

                    rows.sort((a,b)=>{
                        const aVal=a.cells[columnIndex].textContent.trim();
                        const bVal=b.cells[columnIndex].textContent.trim();
                        if(aVal<bVal)return -1*sortDirection;if(aVal>bVal)return 1*sortDirection;return 0;
                    });
                    rows.forEach(row=>table.appendChild(row));
                    table.insertBefore(headerRow,table.firstChild);
                })
            });
        });
    </script>
</body>
</html>
