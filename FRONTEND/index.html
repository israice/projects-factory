<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Projects Manager</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        *:hover { text-decoration: none !important; }
        body { font-family: Arial, sans-serif; background: #1e1e1e; color: #e0e0e0; }
        #boot-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e1e1e;
            color: #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            z-index: 2000;
        }
        #app-root { visibility: hidden; }
        body.app-ready #app-root { visibility: visible; }
        body.app-ready #boot-loader { display: none; }
        body.app-error #boot-loader { color: #ff6b6b; }
        
        /* Header */
        .header-wrapper { display: flex; position: sticky; top: 0; z-index: 100; background: #1e1e1e; }
        .navbar { flex: 1; display: flex; flex-direction: column; background: #2d2d2d; }
        .nav-row { display: flex; gap: 10px; padding: 10px 20px; justify-content: center; }
        .nav-row a { color: #e0e0e0; text-decoration: none; padding: 8px 16px; background: #3d3d3d; border-radius: 4px; }
        .nav-row a:hover { background: #4d4d4d; }
        .welcome-row { padding: 0 20px 10px; display: flex; justify-content: center; }
        .welcome-text { color: #0f0; font-weight: 700; font-family: 'Courier New', monospace; cursor: pointer; }
        
        /* Avatar */
        .avatar-container { position: relative; width: 42px; height: 42px; flex: 0 0 42px; order: -1; }
        .avatar-img { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #4CAF50; }
        .avatar-placeholder { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #4CAF50; 
                               display: flex; align-items: center; justify-content: center; font-size: 23px; }
        
        /* Table */
        .table-container { padding: 0 20px 20px; overflow-x: auto; }
        .search-row { padding: 0 20px 0; display: flex; align-items: center; gap: 12px; width: 100%; }
        .user-inline { color: #e0e0e0; white-space: nowrap; font-weight: 600; }
        .table-search {
            flex: 1 1 auto;
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
        }
        .table-search:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.25);
        }
        table { border-collapse: collapse; width: 100%; min-width: 800px; table-layout: fixed; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; vertical-align: middle; }
        th { background: #2e7d32; color: #fff; text-align: center; cursor: pointer; user-select: none; }
        th:hover { background: #388e3c; }
        th.no-sort { cursor: default; }
        th.no-sort:hover { background: #2e7d32; }
        .rownum-cell { text-align: center; width: 56px; color: #bdbdbd; }
        .rownum-cell:hover { cursor: default; }
        tr { background: #1e1e1e; }
        .installed-row { background: #1a3a1a; }
        .new-project-row { background: #3a2a1a; }
        
        /* Cells */
        .logo-cell { position: relative; text-align: center; width: 60px; cursor: pointer; }
        .logo-cell.active { background: #2a4a2a; }
        .logo-cell.has-unpushed::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #b455ff;
            box-shadow: 0 0 6px rgba(180, 85, 255, 0.7);
        }
        .logo-icon { font-size: 32px; }
        .name-cell { cursor: pointer; color: #4CAF50; font-weight: 600; overflow-wrap: anywhere; word-break: break-word; }
        .name-cell:hover { text-decoration: underline; }
        .name-cell.active { background: #2a4a2a; }
        .description-cell { cursor: pointer; overflow-wrap: anywhere; word-break: break-word; }
        .description-cell.active { background: #2a4a2a; }
        .url-cell { text-align: center; width: 60px; }
        .url-link { text-decoration: none; font-size: 24px; }
        .started-cell { text-align: center; }
        .col-rownum { width: 56px; }
        .col-logo { width: 60px; }
        .col-name { width: 240px; }
        .col-url { width: 60px; }
        .col-started { width: 110px; }
        .date-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 88px;
            background: #3d3d3d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.2;
            white-space: nowrap;
            text-align: center;
        }
        
        /* Action Row */
        .action-row { display: none; }
        .action-row.show { display: table-row; background: #2a2a2a; }
        .action-cell { padding: 10px; text-align: center; }
        .action-btn { display: inline-flex; align-items: center; gap: 6px; margin: 0 8px; padding: 8px 16px;
                      background: #4CAF50; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .action-btn:hover { background: #45a049; }
        .action-visibility { margin: 0 8px; padding: 8px 10px; border: 1px solid #4d4d4d; border-radius: 4px; background: #2a2a2a; color: #e0e0e0; }
        .action-btn[data-action="delete"] { background: #dc3545; }
        .action-btn[data-action="delete"]:hover { background: #c82333; }
        .action-btn[data-action="delete-github"] { background: #b71c1c; }
        .action-btn[data-action="delete-github"]:hover { background: #9a1818; }
        .rename-input { width: 90%; padding: 6px; background: #404040; color: #e0e0e0; 
                        border: 1px solid #4CAF50; border-radius: 4px; font-size: inherit; }

        /* Confirm Modal */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            pointer-events: auto;
        }
        .confirm-overlay[hidden] { display: none !important; }
        .confirm-modal {
            width: min(520px, calc(100vw - 32px));
            background: #2d2d2d;
            border: 1px solid #4d4d4d;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
            pointer-events: auto;
        }
        .confirm-title { font-weight: 700; margin-bottom: 10px; color: #e0e0e0; }
        .confirm-message { color: #d0d0d0; margin-bottom: 14px; overflow-wrap: anywhere; }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .confirm-btn {
            border: 1px solid #4d4d4d;
            background: #3a3a3a;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 8px 14px;
            cursor: pointer;
        }
        .confirm-btn:hover { background: #464646; }
        .confirm-btn.confirm-danger {
            border-color: #b71c1c;
            background: #b71c1c;
            color: #fff;
        }
        .confirm-btn.confirm-danger:hover { background: #9a1818; }
        
        /* Loading */
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div id="boot-loader">Loading projects...</div>
    <div id="confirm-overlay" class="confirm-overlay" hidden>
        <div class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
            <div class="confirm-title" id="confirm-title">Confirm Action</div>
            <div class="confirm-message" id="confirm-message"></div>
            <div class="confirm-actions">
                <button class="confirm-btn" id="confirm-cancel" type="button">Cancel</button>
                <button class="confirm-btn confirm-danger" id="confirm-ok" type="button">Confirm</button>
            </div>
        </div>
    </div>
    <div id="app-root">
    <div class="header-wrapper">
        <div class="navbar">
            <div class="nav-row">
                <a href="#" id="nav-repos">üì¶ Repos: 0</a>
                <a href="#" id="nav-installed">üìÅ Downloaded: 0</a>
                <a href="#" id="nav-local-only">üóÇÔ∏è New Projects: 0</a>
                <a href="#" id="nav-last-url">üöÄ Next: -</a>
                <a href="#" id="btn-create-new">‚ûï Create New</a>
            </div>
            <div class="search-row">
                <div class="avatar-container" id="avatar-container">
                    <div class="avatar-placeholder" id="avatar-placeholder">üì¶</div>
                    <img class="avatar-img" id="avatar-img" style="display:none">
                </div>
                <span class="user-inline" id="nav-username">-</span>
                <input
                    id="table-search"
                    class="table-search"
                    type="text"
                    placeholder="Search by Name, Description, URL, date..."
                    autocomplete="off"
                >
            </div>
            <div class="welcome-row">
                <span class="welcome-text" id="welcome-text"></span>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="repos-table">
            <colgroup>
                <col class="col-rownum">
                <col class="col-logo">
                <col class="col-name">
                <col>
                <col class="col-url">
                <col class="col-started">
            </colgroup>
            <thead>
                <tr>
                    <th class="no-sort">#</th>
                    <th data-sort="type">Logo</th>
                    <th data-sort="name">Name</th>
                    <th data-sort="description">Description</th>
                    <th data-sort="url">URL</th>
                    <th data-sort="created_at">Started</th>
                </tr>
            </thead>
            <tbody id="repos-tbody"></tbody>
        </table>
    </div>

    <script>
        const normalizeRepoUrl = (url = '') => String(url).replace(/\.git$/, '').replace(/\/$/, '');
        const LAST_URL_ROW_KEY = 'projectsFactory:lastUrlRowNo';
        const LOCAL_DESC_KEY = 'projectsFactory:localDescriptions';
        const DEFAULT_PUSH_MESSAGE = '';
        const PUSH_STATE_POLL_MS = 10000;

        function readLocalDescriptions() {
            try {
                const raw = localStorage.getItem(LOCAL_DESC_KEY);
                const parsed = raw ? JSON.parse(raw) : {};
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch {
                return {};
            }
        }

        function writeLocalDescriptions(map) {
            try {
                localStorage.setItem(LOCAL_DESC_KEY, JSON.stringify(map || {}));
            } catch {}
        }

        function setLocalDescription(name, description) {
            const key = String(name || '').trim();
            if (!key) return;
            const map = readLocalDescriptions();
            if (description) map[key] = description;
            else delete map[key];
            writeLocalDescriptions(map);
        }

        function removeLocalDescription(name) {
            const key = String(name || '').trim();
            if (!key) return;
            const map = readLocalDescriptions();
            if (!(key in map)) return;
            delete map[key];
            writeLocalDescriptions(map);
        }

        function renameLocalDescription(oldName, newName) {
            const oldKey = String(oldName || '').trim();
            const newKey = String(newName || '').trim();
            if (!oldKey || !newKey || oldKey === newKey) return;
            const map = readLocalDescriptions();
            if (!(oldKey in map)) return;
            map[newKey] = map[oldKey];
            delete map[oldKey];
            writeLocalDescriptions(map);
        }

        const ConfirmDialog = {
            el: null,
            resolve: null,

            init() {
                this.el = {
                    overlay: document.getElementById('confirm-overlay'),
                    message: document.getElementById('confirm-message'),
                    ok: document.getElementById('confirm-ok'),
                    cancel: document.getElementById('confirm-cancel')
                };
                this.el.ok.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.close(true);
                });
                this.el.cancel.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.close(false);
                });
                this.el.overlay.addEventListener('click', (e) => {
                    if (e.target === this.el.overlay) this.close(false);
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.resolve) this.close(false);
                });
            },

            open(message, opts = {}) {
                const { confirmText = 'Confirm', danger = false } = opts;
                if (this.resolve) this.close(false);
                this.el.message.textContent = message || '';
                this.el.ok.textContent = confirmText;
                this.el.ok.classList.toggle('confirm-danger', !!danger);
                return new Promise((resolve) => {
                    this.resolve = resolve;
                    this.el.overlay.hidden = false;
                    this.el.ok.focus();
                });
            },

            close(result) {
                if (!this.resolve) return;
                const done = this.resolve;
                this.resolve = null;
                this.el.overlay.hidden = true;
                done(!!result);
            }
        };

        async function refreshDataAndView(withServerRefresh = false) {
            if (withServerRefresh) await API.post('/api/refresh', {});
            await State.init();
            UI.updateHeader();
            UI.renderTable();
        }

        let pushStatePollTimer = null;
        function startPushStatePolling() {
            if (pushStatePollTimer) clearInterval(pushStatePollTimer);
            pushStatePollTimer = setInterval(async () => {
                if (document.hidden) return;
                const changed = await State.refreshPushStates();
                if (changed) UI.renderTable();
            }, PUSH_STATE_POLL_MS);
        }

        function formatCreated(value = '') {
            if (!value) return '-';
            const [datePart, timePart = ''] = String(value).split('T');
            const cleanTime = timePart.replace('Z', '').slice(0, 5);
            if (!datePart) return '-';
            return { date: datePart, time: cleanTime || '--:--' };
        }

        function getCreatedAtMs(value = '') {
            const ts = Date.parse(String(value || ''));
            return Number.isFinite(ts) ? ts : -1;
        }

        // State
        const State = {
            username: '', avatarUrl: '', installedCount: 0, repos: [], count: 0,
            installedUrls: new Set(),
            localOnlyCount: 0,
            lastLaunchedRowNo: null,
            localDescriptions: {},
            defaultPushMessage: DEFAULT_PUSH_MESSAGE,

            async init() {
                const [config, reposData] = await Promise.all([
                    fetch('/api/config').then(r => r.json()),
                    fetch('/api/repos').then(r => r.json())
                ]);
                this.username = config.username;
                this.avatarUrl = config.avatar_url;
                this.installedCount = config.installed_count;
                this.defaultPushMessage = String(config.default_push_message || '').trim() || DEFAULT_PUSH_MESSAGE;
                const repos = reposData.repos || [];
                const orderedForRowNo = [...repos].sort((a, b) => {
                    const dt = getCreatedAtMs(b.created_at) - getCreatedAtMs(a.created_at);
                    if (dt !== 0) return dt;
                    return String(a.name || '').localeCompare(String(b.name || ''), undefined, { sensitivity: 'base' });
                });
                const rowNoMap = new Map(
                    orderedForRowNo.map((repo, idx) => [`${repo.name}|${repo.url}`, orderedForRowNo.length - idx])
                );
                this.repos = repos.map(repo => ({
                    ...repo,
                    __rowNo: rowNoMap.get(`${repo.name}|${repo.url}`) || 0
                }));
                this.localDescriptions = readLocalDescriptions();
                this.repos.forEach(repo => {
                    if (!repo.is_new_project) return;
                    const localDesc = this.localDescriptions[repo.name];
                    if (typeof localDesc === 'string') repo.description = localDesc;
                });
                this.localOnlyCount = this.repos.filter(r => r.is_new_project).length;
                this.count = reposData.count || 0;
                // installedUrls comes from config (actual installed repos from MY_REPOS)
                this.installedUrls = new Set(
                    (config.installed_urls || []).map(normalizeRepoUrl)
                );
                const savedRowNo = Number(localStorage.getItem(LAST_URL_ROW_KEY) || 0);
                this.lastLaunchedRowNo = savedRowNo > 0 ? savedRowNo : null;
            },
            async refreshPushStates() {
                let data;
                try {
                    data = await API.get('/api/push-states');
                } catch {
                    return false;
                }
                const items = Array.isArray(data?.items) ? data.items : [];
                const nextMap = new Map(items.map(item => [`${item.name}|${item.url}`, !!item.can_push]));
                let changed = false;
                this.repos.forEach(repo => {
                    const key = `${repo.name}|${repo.url}`;
                    if (!nextMap.has(key)) return;
                    const nextCanPush = !!nextMap.get(key);
                    if (!!repo.can_push !== nextCanPush) {
                        repo.can_push = nextCanPush;
                        changed = true;
                    }
                });
                return changed;
            },

            isInstalled(repo) {
                if (repo.is_new_project) return false;
                const url = normalizeRepoUrl(repo.url);
                return this.installedUrls.has(url);
            },

            getLaunchableRepos() {
                return [...this.repos]
                    .filter(r => Number(r.__rowNo) > 0)
                    .sort((a, b) => Number(a.__rowNo) - Number(b.__rowNo));
            },

            getNextLaunchRepo() {
                const launchable = this.getLaunchableRepos();
                if (!launchable.length) return null;
                const last = Number(this.lastLaunchedRowNo || 0);
                return launchable.find(r => Number(r.__rowNo) > last) || launchable[0];
            }
        };

        // API
        const API = {
            async request(endpoint, options = {}) {
                const r = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                const text = await r.text();
                let data = {};
                try { data = text ? JSON.parse(text) : {}; } catch {}
                if (!r.ok) throw new Error(data.detail || data.error || text || `HTTP ${r.status}`);
                return data;
            },
            get: (endpoint) => API.request(endpoint, { method: 'GET' }),
            post: (endpoint, body) => API.request(endpoint, { method: 'POST', body: JSON.stringify(body) }),
            installRepos: (urls) => API.post('/api/install', { repos: urls }),
            pushRepo: (path, message, versionMode = 'use_existing') => API.post('/api/push', { path, message, version_mode: versionMode }),
            addToGithub: (name, description, visibility = 'public') => API.post('/api/add-to-github', { name, description, visibility }),
            deleteRepos: (names) => API.post('/api/delete', { repos: names }),
            deleteGithubRepo: (name) => API.post('/api/delete-github', { name }),
            renameLocal: (old, new_) => API.post('/api/rename', { old_name: old, new_name: new_ }),
            renameGithub: (old, new_) => API.post('/api/rename-github', { old_name: old, new_name: new_ }),
            updateDescription: (name, description) => API.post('/api/update-description', { name, description }),
            openFolder: (path) => API.post('/api/open-folder', { path }),
            openFolderExplorer: (path) => API.post('/api/open-folder-explorer', { path }),
            createProject: () => API.post('/api/create-project')
        };

        // UI
        const UI = {
            el: {},
            sortKey: 'created_at',
            sortDir: 'desc',
            welcomeTimer: null,
            init() {
                this.el = {
                    username: document.getElementById('nav-username'),
                    repos: document.getElementById('nav-repos'),
                    installed: document.getElementById('nav-installed'),
                    localOnly: document.getElementById('nav-local-only'),
                    lastUrl: document.getElementById('nav-last-url'),
                    welcome: document.getElementById('welcome-text'),
                    avatarContainer: document.getElementById('avatar-container'),
                    avatarImg: document.getElementById('avatar-img'),
                    avatarPlaceholder: document.getElementById('avatar-placeholder'),
                    search: document.getElementById('table-search'),
                    tbody: document.getElementById('repos-tbody'),
                    headers: Array.from(document.querySelectorAll('#repos-table thead th[data-sort]'))
                };
                this.updateSortHeader();
            },
            setSort(key) {
                if (this.sortKey === key) {
                    this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortKey = key;
                    this.sortDir = key === 'created_at' ? 'desc' : 'asc';
                }
                this.updateSortHeader();
                this.renderTable();
            },
            updateSortHeader() {
                if (!this.el.headers) return;
                this.el.headers.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                    if (h.dataset.sort === this.sortKey) {
                        h.classList.add(this.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            },
            getSortedRepos() {
                const list = [...State.repos];
                const dir = this.sortDir === 'asc' ? 1 : -1;
                const cmpText = (a, b) => String(a || '').localeCompare(String(b || ''), undefined, { sensitivity: 'base' });
                list.sort((a, b) => {
                    let result = 0;
                    switch (this.sortKey) {
                        case 'name':
                            result = cmpText(a.name, b.name);
                            break;
                        case 'description':
                            result = cmpText(a.description, b.description);
                            break;
                        case 'url':
                            result = cmpText(a.url, b.url);
                            break;
                        case 'created_at': {
                            result = getCreatedAtMs(a.created_at) - getCreatedAtMs(b.created_at);
                            break;
                        }
                        case 'type': {
                            const weight = (repo) => repo.is_new_project ? 0 : (repo.private ? 1 : 2);
                            result = weight(a) - weight(b);
                            break;
                        }
                        default:
                            result = 0;
                    }
                    return result * dir;
                });
                return list;
            },
            getFilteredRepos() {
                const query = String(this.el.search?.value || '').trim().toLowerCase();
                if (!query) return this.getSortedRepos();
                const tokens = query.split(/\s+/).filter(Boolean);
                return this.getSortedRepos().filter(repo => {
                    const created = formatCreated(repo.created_at);
                    const haystack = [
                        repo.name,
                        repo.description,
                        repo.url,
                        created.date,
                        created.time,
                        repo.private ? 'private lock' : 'public globe',
                        repo.is_new_project ? 'local folder' : 'github'
                    ].join(' ').toLowerCase();
                    return tokens.every(token => haystack.includes(token));
                });
            },
            updateHeader() {
                this.el.username.textContent = State.username || '-';
                this.el.repos.textContent = `üì¶ Repos: ${State.count}`;
                this.el.installed.textContent = `üìÅ Downloaded: ${State.installedCount}`;
                this.el.localOnly.textContent = `üóÇÔ∏è New Projects: ${State.localOnlyCount}`;
                const nextRepo = State.getNextLaunchRepo();
                this.el.lastUrl.textContent = `üöÄ Next: ${nextRepo ? Number(nextRepo.__rowNo) : '-'}`;
                if (State.avatarUrl) {
                    this.el.avatarImg.src = State.avatarUrl;
                    this.el.avatarImg.style.display = 'block';
                    this.el.avatarPlaceholder.style.display = 'none';
                } else {
                    this.el.avatarImg.style.display = 'none';
                    this.el.avatarPlaceholder.style.display = 'flex';
                }
            },
            showWelcome(msg) {
                this.el.welcome.textContent = msg || '';
                if (this.welcomeTimer) clearTimeout(this.welcomeTimer);
                if (msg) {
                    this.welcomeTimer = setTimeout(() => {
                        this.el.welcome.textContent = '';
                        this.welcomeTimer = null;
                    }, 5000);
                }
            },
            markLastUrlLaunch(rowNo) {
                State.lastLaunchedRowNo = rowNo || null;
                if (State.lastLaunchedRowNo) localStorage.setItem(LAST_URL_ROW_KEY, String(State.lastLaunchedRowNo));
                else localStorage.removeItem(LAST_URL_ROW_KEY);
                this.updateHeader();
            },
            renderTable() {
                this.el.tbody.innerHTML = '';
                this.getFilteredRepos().forEach(repo => {
                    const installed = State.isInstalled(repo);
                    const isNew = repo.is_new_project;
                    const rowClass = isNew ? 'new-project-row' : installed ? 'installed-row' : '';
                    const logoClass = repo.can_push ? 'logo-cell has-unpushed' : 'logo-cell';
                    const logo = isNew ? 'üìÅ' : (repo.private ? 'üîí' : 'üåç');
                    const created = formatCreated(repo.created_at);
                    const tr = document.createElement('tr');
                    if (rowClass) tr.className = rowClass;
                    tr.dataset.name = repo.name;
                    tr.dataset.url = repo.url;
                    tr.dataset.isNew = isNew;
                    tr.dataset.installed = installed;
                    tr.dataset.canPush = repo.can_push ? 'true' : 'false';
                    tr.innerHTML = `
                        <td class="rownum-cell">${repo.__rowNo || ''}</td>
                        <td class="${logoClass}" data-repo="${this.escape(repo.name)}" data-url="${this.escape(repo.url)}"><span class="logo-icon">üì¶</span></td>
                        <td class="name-cell" data-repo="${this.escape(repo.name)}" data-url="${this.escape(repo.url)}">${this.escape(repo.name)}</td>
                        <td class="description-cell" data-repo="${this.escape(repo.name)}" data-url="${this.escape(repo.url)}">${this.escape(repo.description || '')}</td>
                        <td class="url-cell">
                            <a href="${this.escape(repo.url)}" class="url-link" data-url="${this.escape(repo.url)}" data-is-local="${isNew}">${logo}</a>
                        </td>
                        <td class="started-cell"><span class="date-badge">${created.date}<br>${created.time}</span></td>
                    `;
                    this.el.tbody.appendChild(tr);
                });
            },
            openActionRow(cell) {
                const row = cell.closest('tr');
                const name = cell.dataset.repo;
                const url = cell.dataset.url;
                const isNew = row.dataset.isNew === 'true';
                const installed = row.dataset.installed === 'true';
                const canPush = row.dataset.canPush === 'true';
                const active = cell.classList.contains('active');

                this.closeAllActionRows(cell);

                if (!active) {
                    if (!isNew && !installed) return;
                    const actionRow = document.createElement('tr');
                    actionRow.className = 'action-row show';
                    let buttons = '';
                    if (isNew) {
                        const pushMode = canPush
                            ? `<select class="action-visibility action-push-mode" data-action="push-mode">
                                <option value="use_existing" selected>Use Existing</option>
                                <option value="generate_version">Generate Version</option>
                            </select>`
                            : '';
                        const pushBtn = canPush
                            ? `<button class="action-btn" data-action="push" data-name="${this.escape(name)}" data-url="${this.escape(url)}">‚¨ÜÔ∏è Push</button>`
                            : '';
                        const repoBtn = isHttpUrl(url)
                            ? `<button class="action-btn" data-action="open-repository" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üåê Repository</button>`
                            : '';
                        buttons = `
                            <button class="action-btn" data-action="open-folder" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üìÇ Folder</button>
                            ${repoBtn}
                            ${pushMode}
                            ${pushBtn}
                            <select class="action-visibility" data-action="visibility">
                                <option value="public" selected>Public</option>
                                <option value="private">Private</option>
                            </select>
                            <button class="action-btn" data-action="add-to-github" data-name="${this.escape(name)}" data-url="${this.escape(url)}">‚òÅÔ∏è Add to GitHub</button>
                            <button class="action-btn" data-action="delete" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üóëÔ∏è Local Delete</button>
                        `;
                    } else if (installed) {
                        const pushMode = canPush
                            ? `<select class="action-visibility action-push-mode" data-action="push-mode">
                                <option value="use_existing" selected>Use Existing</option>
                                <option value="generate_version">Generate Version</option>
                            </select>`
                            : '';
                        const pushBtn = canPush
                            ? `<button class="action-btn" data-action="push" data-name="${this.escape(name)}" data-url="${this.escape(url)}">‚¨ÜÔ∏è Push</button>`
                            : '';
                        const repoBtn = isHttpUrl(url)
                            ? `<button class="action-btn" data-action="open-repository" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üåê Repository</button>`
                            : '';
                        buttons = `
                            <button class="action-btn" data-action="open-folder" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üìÇ Folder</button>
                            ${repoBtn}
                            ${pushMode}
                            ${pushBtn}
                            <button class="action-btn" data-action="delete" data-name="${this.escape(name)}" data-url="${this.escape(url)}">üóëÔ∏è Local Delete</button>
                            <button class="action-btn" data-action="delete-github" data-name="${this.escape(name)}" data-url="${this.escape(url)}">‚òÅÔ∏è Delete Repository</button>
                        `;
                    }
                    actionRow.innerHTML = `<td colspan="6" class="action-cell">${buttons}</td>`;
                    row.parentNode.insertBefore(actionRow, row.nextSibling);
                    cell.classList.add('active');
                } else {
                    cell.classList.remove('active');
                    const ar = row.nextElementSibling;
                    if (ar && ar.classList.contains('action-row')) ar.remove();
                }
            },
            closeAllActionRows(exceptCell = null) {
                document.querySelectorAll('.logo-cell.active').forEach(c => {
                    if (exceptCell && c === exceptCell) return;
                    c.classList.remove('active');
                    const ar = c.closest('tr').nextElementSibling;
                    if (ar && ar.classList.contains('action-row')) ar.remove();
                });
            },
            escape(str) {
                const d = document.createElement('div');
                d.textContent = str;
                return d.innerHTML;
            },
            markInstalled(url) {
                const row = document.querySelector(`tr[data-url="${CSS.escape(url)}"]`);
                if (row) { row.classList.add('installed-row'); row.dataset.installed = 'true'; }
            },
            removeRow(name) {
                const row = document.querySelector(`tr[data-name="${CSS.escape(name)}"]`);
                if (row) {
                    if (row.dataset.isNew === 'true') {
                        row.style.display = 'none';
                        // Close action row for deleted new project
                        const ar = row.nextElementSibling;
                        if (ar && ar.classList.contains('action-row')) ar.remove();
                    } else {
                        row.classList.remove('installed-row');
                        row.dataset.installed = 'false';
                    }
                }
            }
        };

        // Actions
        async function handleCreateProject() {
            UI.showWelcome('‚è≥ Creating project...');
            try {
                const r = await API.createProject();
                UI.showWelcome(r.message || '‚úÖ Project created');
                await refreshDataAndView(false);
            } catch (e) { UI.showWelcome('‚ùå Create failed: ' + e.message); }
        }

        async function handleInstallConfirm(repo) {
            UI.showWelcome('‚è≥ Installing ' + repo.name + '...');
            try {
                await API.installRepos([repo.url]);
                State.installedUrls.add(normalizeRepoUrl(repo.url));
                State.installedCount = State.installedUrls.size;
                UI.updateHeader();
                UI.markInstalled(repo.url);
                UI.showWelcome('‚úÖ Installed ' + repo.name);
                closeActionRow(repo.url);
                return true;
            } catch (e) { UI.showWelcome('‚ùå Install failed: ' + e.message); }
            return false;
        }

        async function handleDeleteConfirm(repo) {
            UI.showWelcome('‚è≥ Deleting ' + repo.name + '...');
            try {
                await API.deleteRepos([repo.name]);
                const url = normalizeRepoUrl(repo.url);
                State.installedUrls.delete(url);
                State.installedCount = State.installedUrls.size;
                if (repo.url.includes('NEW_PROJECTS')) {
                    removeLocalDescription(repo.name);
                    State.localDescriptions = readLocalDescriptions();
                    State.repos = State.repos.filter(r => r.name !== repo.name);
                }
                UI.updateHeader();
                UI.removeRow(repo.name);
                UI.showWelcome('‚úÖ Deleted ' + repo.name);
                // Close action row after deletion
                closeActionRow(repo.url);
            } catch (e) { UI.showWelcome('‚ùå Delete failed: ' + e.message); }
        }

        async function handleAddToGithubConfirm(repo, visibility = 'public') {
            closeActionRow(repo.url);
            UI.showWelcome(`‚è≥ Creating ${visibility} GitHub repository for ${repo.name}...`);
            try {
                const sourceRepo = State.repos.find(r => r.name === repo.name && r.url === repo.url);
                const description = sourceRepo?.description || '';
                const r = await API.addToGithub(repo.name, description, visibility);
                removeLocalDescription(repo.name);
                State.localDescriptions = readLocalDescriptions();
                UI.showWelcome(`‚úÖ Added to GitHub (${visibility}): ` + (r.repo || repo.name));
                await refreshDataAndView(false);
            } catch (e) {
                UI.showWelcome('‚ùå Add to GitHub failed: ' + e.message);
            }
        }

        async function handleDeleteGithubConfirm(repo) {
            UI.showWelcome('‚è≥ Deleting from GitHub ' + repo.name + '...');
            try {
                await API.deleteGithubRepo(repo.name);
                State.repos = State.repos.filter(r => !(r.name === repo.name && r.url === repo.url));
                State.count = State.repos.filter(r => !r.is_new_project).length;
                State.localOnlyCount = State.repos.filter(r => r.is_new_project).length;
                UI.updateHeader();
                UI.renderTable();
                UI.showWelcome('‚úÖ Deleted from GitHub ' + repo.name);
                closeActionRow(repo.url);
            } catch (e) {
                UI.showWelcome('‚ùå GitHub delete failed: ' + e.message);
            }
        }

        async function handlePushConfirm(repo, versionMode = 'use_existing') {
            closeActionRow(repo.url);
            setRepoCanPush(repo, false);
            UI.showWelcome('‚è≥ Updating VERSION.md and pushing ' + repo.name + '...');
            try {
                await API.pushRepo(repo.url, '', versionMode);
                UI.showWelcome('‚úÖ Push completed for ' + repo.name);
            } catch (e) {
                setRepoCanPush(repo, true);
                UI.showWelcome('‚ùå Push failed: ' + e.message);
            }
        }

        async function launchRepoFromUrlAction(repo, rowNo, isLocal) {
            if (!repo || !repo.url) return;
            if (isLocal) {
                try {
                    await API.openFolder(repo.url);
                    UI.markLastUrlLaunch(rowNo);
                    UI.showWelcome('‚úÖ Opened in VS Code');
                } catch (err) {
                    UI.showWelcome('‚ùå Open failed: ' + err.message);
                }
                return;
            }

            const isInstalled = State.isInstalled(repo);
            if (!isInstalled) {
                const ok = await handleInstallConfirm(repo);
                if (!ok) return;
            }
            try {
                await API.openFolder(repo.name || repo.url);
                UI.markLastUrlLaunch(rowNo);
                UI.showWelcome('‚úÖ Opened in VS Code');
            } catch (err) {
                UI.showWelcome('‚ùå Open failed: ' + err.message);
            }
        }

        async function launchNextFromLastOpened() {
            const next = State.getNextLaunchRepo();
            if (!next) {
                UI.showWelcome('‚ùå No projects available');
                return;
            }

            await launchRepoFromUrlAction(
                { name: next.name, url: next.url },
                Number(next.__rowNo),
                !!next.is_new_project
            );
        }

        function isHttpUrl(value = '') {
            return /^https?:\/\//i.test(String(value || '').trim());
        }

        function makeEditable(cell, name, url, endpoint) {
            const original = name;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = original;
            input.className = 'rename-input';
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            async function save() {
                const newName = input.value.trim();
                if (newName && newName !== original) {
                    try {
                        const fn = endpoint.includes('rename-github') ? 'renameGithub' : 'renameLocal';
                        await API[fn](original, newName);
                        const newUrl = url.replace(new RegExp(`${original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`), newName);
                        if (fn === 'renameLocal') {
                            renameLocalDescription(original, newName);
                            State.localDescriptions = readLocalDescriptions();
                        }
                        const repoItem = State.repos.find(r => r.name === original);
                        if (repoItem) {
                            repoItem.name = newName;
                            repoItem.url = newUrl;
                        }
                        cell.textContent = newName;
                        cell.dataset.repo = newName;
                        cell.dataset.url = newUrl;
                        const row = cell.closest('tr');
                        if (row) {
                            row.dataset.name = newName;
                            row.dataset.url = newUrl;
                            const logoCell = row.querySelector('.logo-cell');
                            if (logoCell) {
                                logoCell.dataset.repo = newName;
                                logoCell.dataset.url = newUrl;
                            }
                            const descCell = row.querySelector('.description-cell');
                            if (descCell) {
                                descCell.dataset.repo = newName;
                                descCell.dataset.url = newUrl;
                            }
                        }
                        updateActionButtons(original, newName);
                        UI.showWelcome('‚úÖ Renamed to ' + newName);
                        closeActionRow(newUrl);
                    } catch (e) {
                        UI.showWelcome('‚ùå Rename failed: ' + e.message);
                        cell.textContent = original;
                    }
                } else { cell.textContent = original; }
            }
            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') input.blur();
                else if (e.key === 'Escape') cell.textContent = original;
            });
        }

        function makeDescriptionEditable(cell, name, isLocal = false) {
            const original = cell.textContent || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = original;
            input.className = 'rename-input';
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            async function save() {
                const newDescription = input.value.trim();
                if (newDescription !== original) {
                    try {
                        const repoItem = State.repos.find(r => r.name === name);
                        if (isLocal) {
                            setLocalDescription(name, newDescription);
                            State.localDescriptions = readLocalDescriptions();
                        } else {
                            await API.updateDescription(name, newDescription);
                        }
                        if (repoItem) repoItem.description = newDescription;
                        cell.textContent = newDescription;
                        UI.showWelcome('‚úÖ Description updated');
                    } catch (e) {
                        UI.showWelcome('‚ùå Description update failed: ' + e.message);
                        cell.textContent = original;
                    }
                } else {
                    cell.textContent = original;
                }
            }

            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') input.blur();
                else if (e.key === 'Escape') cell.textContent = original;
            });
        }

        function updateActionButtons(oldName, newName) {
            document.querySelectorAll('.action-btn').forEach(btn => {
                if (btn.dataset.name === oldName) btn.dataset.name = newName;
            });
        }

        function closeActionRow(url) {
            const row = document.querySelector(`tr[data-url="${CSS.escape(url)}"]`);
            if (row) {
                const logoCell = row.querySelector('.logo-cell');
                if (logoCell) logoCell.classList.remove('active');
                const ar = row.nextElementSibling;
                if (ar && ar.classList.contains('action-row')) ar.remove();
            }
        }

        function setRepoCanPush(repo, canPush) {
            const value = !!canPush;
            const row = document.querySelector(`tr[data-url="${CSS.escape(repo.url)}"]`);
            if (row) {
                row.dataset.canPush = value ? 'true' : 'false';
                const logoCell = row.querySelector('.logo-cell');
                if (logoCell) logoCell.classList.toggle('has-unpushed', value);
            }
            const stateItem = State.repos.find(r => r.name === repo.name && r.url === repo.url);
            if (stateItem) stateItem.can_push = value;
        }

        function finishBootstrap(errorMessage = '') {
            if (errorMessage) {
                document.body.classList.add('app-error');
                const loader = document.getElementById('boot-loader');
                if (loader) loader.textContent = errorMessage;
                return;
            }
            document.body.classList.remove('app-error');
            document.body.classList.add('app-ready');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            ConfirmDialog.init();
            UI.init();
            try {
                await refreshDataAndView(false);
                startPushStatePolling();
                finishBootstrap();
                UI.showWelcome(UI.el.welcome.textContent || '');
            } catch (e) {
                finishBootstrap('Failed to load data');
                UI.showWelcome('‚ùå Init failed: ' + e.message);
                return;
            }

            document.getElementById('btn-create-new').addEventListener('click', async (e) => {
                e.preventDefault();
                await handleCreateProject();
            });

            UI.el.lastUrl.addEventListener('click', async (e) => {
                e.preventDefault();
                await launchNextFromLastOpened();
            });

            UI.el.welcome.addEventListener('click', () => UI.showWelcome('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä'));
            UI.el.search.addEventListener('input', () => UI.renderTable());
            UI.el.headers.forEach(header => {
                header.addEventListener('click', () => UI.setSort(header.dataset.sort));
            });

            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.logo-cell');
                if (!cell) return;
                e.stopPropagation();
                UI.openActionRow(cell);
            });

            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.name-cell');
                if (!cell) return;
                e.stopPropagation();
                const row = cell.closest('tr');
                const endpoint = row && row.dataset.isNew === 'true' ? '/api/rename' : '/api/rename-github';
                makeEditable(cell, cell.dataset.repo, cell.dataset.url, endpoint);
            });

            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.description-cell');
                if (!cell) return;
                e.stopPropagation();
                const row = cell.closest('tr');
                if (!row) return;
                const isLocal = row.dataset.isNew === 'true';
                makeDescriptionEditable(cell, cell.dataset.repo, isLocal);
            });
            document.addEventListener('click', (e) => {
                if (e.target.closest('.logo-cell') || e.target.closest('.action-row')) return;
                UI.closeAllActionRows();
            });

            document.addEventListener('click', async (e) => {
                const link = e.target.closest('.url-link');
                if (link) {
                    e.preventDefault();
                    const row = link.closest('tr');
                    const repo = {
                        name: row ? row.dataset.name : '',
                        url: link.dataset.url
                    };
                    const rowNo = row ? Number(row.querySelector('.rownum-cell')?.textContent || 0) : 0;
                    await launchRepoFromUrlAction(repo, rowNo, link.dataset.isLocal === 'true');
                }
            });

            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('.action-btn');
                if (btn) {
                    e.preventDefault();
                    const { action, name: repoName, url: repoUrl } = btn.dataset;
                    const repo = { name: repoName, url: repoUrl };
                    if (action === 'add-to-github') {
                        const actionCell = btn.closest('.action-cell');
                        const visibilitySelect = actionCell ? actionCell.querySelector('.action-visibility') : null;
                        const vis = visibilitySelect && visibilitySelect.value === 'private' ? 'private' : 'public';
                        await handleAddToGithubConfirm(repo, vis);
                    }
                    else if (action === 'push') {
                        const actionCell = btn.closest('.action-cell');
                        const pushModeSelect = actionCell ? actionCell.querySelector('.action-push-mode') : null;
                        const pushMode = pushModeSelect ? String(pushModeSelect.value || 'use_existing') : 'use_existing';
                        await handlePushConfirm(repo, pushMode);
                    }
                    else if (action === 'open-folder') {
                        try {
                            await API.openFolderExplorer(repo.url || repo.name);
                            UI.showWelcome('‚úÖ Folder opened');
                            closeActionRow(repo.url);
                        } catch (e) {
                            UI.showWelcome('‚ùå Open failed: ' + e.message);
                        }
                    }
                    else if (action === 'open-repository') {
                        if (!isHttpUrl(repo.url)) {
                            UI.showWelcome('‚ùå GitHub link not found');
                            return;
                        }
                        window.open(repo.url, '_blank', 'noopener');
                        UI.showWelcome('‚úÖ Repository opened');
                        closeActionRow(repo.url);
                    }
                    else if (action === 'delete') {
                        const ok = await ConfirmDialog.open(`Delete "${repoName}"?`, { confirmText: 'Delete', danger: true });
                        if (ok) await handleDeleteConfirm(repo);
                    }
                    else if (action === 'delete-github') {
                        const ok = await ConfirmDialog.open(`Delete "${repoName}" from GitHub?`, { confirmText: 'Delete', danger: true });
                        if (ok) await handleDeleteGithubConfirm(repo);
                    }
                }
            });

        });
    </script>
    </div>
</body>
</html>
