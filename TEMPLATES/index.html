<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repositories Manager</title>
    <link rel="stylesheet" href="static/styles.css">
    <style>
        /* Critical CSS for instant render - prevents FOUC */
        body { font-family: Arial, sans-serif; padding: 20px; background: #1e1e1e; color: #e0e0e0; margin: 0; }
        .header-wrapper { position: sticky; top: 0; z-index: 1000; display: flex; gap: 0; }
        .navbar { background: #2d2d2d; padding: 10px 20px 0; display: flex; gap: 10px; }
        .navbar a { color: #e0e0e0; text-decoration: none; padding: 8px 16px; }
        .logo-wrapper { background: #2d2d2d; display: flex; align-items: center; min-width: 80px; }
        .logo-container { padding: 10px 20px 10px 0; position: relative; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #4CAF50; }
        .logo-icon { font-size: 48px; color: #4CAF50; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background: #2e7d32; color: #fff; text-align: center; }
        tr { background: #1e1e1e; }
        .welcome-text { color: #0f0; font-weight: 700; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="header-wrapper">
        <div style="flex:1;display:flex;flex-direction:column">
            <div id="panel-1" class="navbar">
                <a href="#" id="nav-username">üë® User: {{ username if username else '-' }}</a>
                <a href="#" id="nav-repos">üì¶ Repos: {{ repos_count if repos_count else 0 }}</a>
                <a href="#" id="nav-installed">üìÅ Installed: {{ installed_count if installed_count else 0 }}</a>
            </div>
            <div id="panel-2" class="navbar"></div>
            <div id="panel-3" class="header">
                <span class="welcome-text" id="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∞—Å—Ç–µ—Ä</span>
            </div>
            <div id="log-panel" class="header"></div>
        </div>
        <div class="logo-wrapper">
            <div class="logo-container" id="avatar-container" style="cursor:pointer;position:relative">
                {% if avatar_url %}
                <img src="{{ avatar_url }}" alt="Avatar" class="logo-img" id="avatar-img">
                <span class="logo-icon" id="avatar-placeholder" style="display:none">üì¶</span>
                {% else %}
                <span class="logo-icon" id="avatar-placeholder">üì¶</span>
                <img src="" alt="Avatar" class="logo-img" id="avatar-img" style="display:none">
                {% endif %}
                <div id="avatar-menu" class="avatar-menu" style="display:none">
                    <a href="#" id="btn-create-new">‚ûï Create New</a>
                    <a href="#" id="btn-refresh">üîÑ Refresh</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <h3>Confirm Installation</h3>
            <div class="modal-body" id="modal-repo-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">Install</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal">
            <h3>Confirm Deletion</h3>
            <div class="modal-body" id="modal-delete-repo-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-delete-cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modal-delete-confirm" style="background:#dc3545">Delete</button>
            </div>
        </div>
    </div>

    <!-- Main Table - Server Rendered -->
    <table id="repos-table">
        <thead>
            <tr>
                <th>Logo</th>
                <th class="sortable" data-sort="name">Projets</th>
                <th class="sortable" data-sort="description">Description</th>
                <th class="sortable" data-sort="url">URL</th>
                <th class="sortable" data-sort="created_at">Started</th>
            </tr>
        </thead>
        <tbody id="repos-tbody">
            {% if repos %}
            <!-- Server-rendered rows for instant display -->
            {% for repo in repos %}
            {% set normalized_url = repo.url[:-4] if repo.url.endswith('.git') else repo.url %}
            {% set normalized_url = normalized_url.rstrip('/') %}
            {% set is_installed = normalized_url in installed_urls %}
            {% set is_new_project = repo.is_new_project if repo.is_new_project else False %}
            {% set row_class = 'new-project-row' if is_new_project else ('installed-row' if is_installed else '') %}
            {% set logo = 'üìÅ' if is_new_project else ('üîí' if repo.private else 'üåç') %}
            {% set created_date = repo.created_at[:10] if repo.created_at else '' %}
            {% set created_time = repo.created_at[11:19] if repo.created_at and repo.created_at|length > 11 else '' %}
            <tr class="{{ row_class }}" data-name="{{ repo.name }}" data-url="{{ repo.url }}" data-is-new="{{ is_new_project }}" data-is-installed="{{ is_installed }}">
                <td class="logo-cell">
                    <span class="logo-icon" style="font-size:32px">üì¶</span>
                </td>
                <td class="name-cell" data-repo="{{ repo.name }}" data-url="{{ repo.url }}" title="Click to install/delete">
                    {{ repo.name }}
                </td>
                <td>{{ repo.description or '' }}</td>
                <td class="url-cell">
                    <a href="{{ repo.url }}" class="url-link" data-url="{{ repo.url }}" data-is-local="{{ is_new_project }}">
                        {{ logo }}
                    </a>
                </td>
                <td>
                    <span class="date-badge">
                        {{ created_date }}<br>{{ created_time }}
                    </span>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <!-- Client will render rows dynamically -->
            {% endif %}
        </tbody>
    </table>

    <!-- Inline script for instant state -->
    <script>
        // Pre-load state from server for instant hydration
        window.__INITIAL_STATE__ = {
            username: "{{ username if username else '' }}",
            avatarUrl: "{{ avatar_url if avatar_url else '' }}",
            installedCount: {{ installed_count if installed_count else 0 }},
            reposCount: {{ repos_count if repos_count else 0 }},
            repos: {{ repos_json | safe }},
            installedUrls: {{ installed_urls_json | safe }}
        };
    </script>

    <!-- Application Scripts -->
    <script src="static/api.js"></script>
    <script src="static/state.js"></script>
    <script src="static/ui.js"></script>
    <script src="static/app.js"></script>
</body>
</html>
